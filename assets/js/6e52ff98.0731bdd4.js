"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[636],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>b});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=c(a),m=o,b=d["".concat(l,".").concat(m)]||d[m]||u[m]||r;return a?n.createElement(b,s(s({ref:t},p),{},{components:a})):n.createElement(b,s({ref:t},p))}));function b(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,s=new Array(r);s[0]=m;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[d]="string"==typeof e?e:o,s[1]=i;for(var c=2;c<r;c++)s[c]=a[c];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},4206:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var n=a(7462),o=(a(7294),a(3905));const r={title:"Transactional outbox pattern",slug:"transactional-outbox-pattern",sidebar_position:5},s="Transactional outbox pattern",i={unversionedId:"explore/code/transactional-outbox-pattern",id:"explore/code/transactional-outbox-pattern",title:"Transactional outbox pattern",description:"Context and problem",source:"@site/docs/explore/code/transactional-outbox-pattern.md",sourceDirName:"explore/code",slug:"/explore/code/transactional-outbox-pattern",permalink:"/e-shop/explore/code/transactional-outbox-pattern",draft:!1,editUrl:"https://github.com/kkhanhluu/eshop/docs/explore/code/transactional-outbox-pattern.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"Transactional outbox pattern",slug:"transactional-outbox-pattern",sidebar_position:5},sidebar:"docs",previous:{title:"Simplified CQRS",permalink:"/e-shop/explore/code/simplified-cqrs"},next:{title:"Saga pattern",permalink:"/e-shop/explore/code/saga-pattern"}},l={},c=[{value:"Context and problem",id:"context-and-problem",level:2},{value:"Conceptual overview",id:"conceptual-overview",level:2},{value:"Code details",id:"code-details",level:2}],p={toc:c},d="wrapper";function u(e){let{components:t,...r}=e;return(0,o.kt)(d,(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"transactional-outbox-pattern"},"Transactional outbox pattern"),(0,o.kt)("h2",{id:"context-and-problem"},"Context and problem"),(0,o.kt)("p",null,"In a microservices system, message/event queues are one of the most popular ways to implement communication between services. In most cases, a service needs to update its own database and then publish the message/events. For example, in the payment service, after receiving a request to create a payment, the service needs to create an entry in the database and then publish a message to the order service notifying that the order has been checked out."),(0,o.kt)("p",null,"The traditional solution is to use a database transaction to update the database and then, after the transaction is finished, publish the corresponding message to the queue. This approach works well until an error occurs between the transaction and publishing the corresponding message for any reason (i.e., network errors, host failure, etc.). In this case, the database is updated, but other services won't be notified of that change. Therefore, a mechanism is needed to ensure that a service updates the database and sends messages atomically."),(0,o.kt)("h2",{id:"conceptual-overview"},"Conceptual overview"),(0,o.kt)("p",null,"If the service needs to update its database, messages/events will be inserted into an ",(0,o.kt)("inlineCode",{parentName:"p"},"outbox")," table as part of local transaction. A separate ",(0,o.kt)("inlineCode",{parentName:"p"},"message relay")," will process this ",(0,o.kt)("inlineCode",{parentName:"p"},"outbox")," table, query the events inserted to database and publish them to message broker. This ",(0,o.kt)("a",{parentName:"p",href:"https://microservices.io/patterns/data/transactional-outbox.html"},"diagram")," will illustrate the transactional outbox pattern\n",(0,o.kt)("img",{parentName:"p",src:"https://microservices.io/i/patterns/data/ReliablePublication.png",alt:"outbox-pattern"})),(0,o.kt)("h2",{id:"code-details"},"Code details"),(0,o.kt)("p",null,"Transactional outbox pattern can be found in ",(0,o.kt)("inlineCode",{parentName:"p"},"inventory-service"),". An outbox object will also be inserted to database as part of local transaction. After that, service'll try to send message. If sending message successfully, the outbox can be safely deleted from database. Otherwise, it should be kept in database for message relay to process later."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"transactional outbox example",src:a(7979).Z,width:"1116",height:"726"})),(0,o.kt)("p",null,"In this example, message relay is a scheduled task that looks into the ",(0,o.kt)("inlineCode",{parentName:"p"},"outbox")," table at a fixed frequency, try to send those message and finally delete them from the table."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"message relay example",src:a(1211).Z,width:"1136",height:"593"})),(0,o.kt)("p",null,"This is a very basic example to demonstrate how the ",(0,o.kt)("inlineCode",{parentName:"p"},"transactional outbox pattern")," works. For a more production-grade solution, using ",(0,o.kt)("a",{parentName:"p",href:"https://microservices.io/patterns/data/transaction-log-tailing.html"},"transaction log tailing")," along with a managed platform like ",(0,o.kt)("a",{parentName:"p",href:"https://debezium.io/"},"Debezium")," should be considered"))}u.isMDXComponent=!0},1211:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/message-relay-ceba701bae94642036496b6111c7f673.png"},7979:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/transactional-outbox-15a803ea55901b52fae9ec837d8d3621.png"}}]);