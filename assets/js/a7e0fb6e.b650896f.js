"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[122],{3905:(e,t,a)=>{a.d(t,{Zo:()=>l,kt:()=>u});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},o=Object.keys(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)a=o[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var c=r.createContext({}),p=function(e){var t=r.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},l=function(e){var t=p(e.components);return r.createElement(c.Provider,{value:t},e.children)},h="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,c=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),h=p(a),m=n,u=h["".concat(c,".").concat(m)]||h[m]||d[m]||o;return a?r.createElement(u,i(i({ref:t},l),{},{components:a})):r.createElement(u,i({ref:t},l))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,i=new Array(o);i[0]=m;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s[h]="string"==typeof e?e:n,i[1]=s;for(var p=2;p<o;p++)i[p]=a[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,a)}m.displayName="MDXCreateElement"},9827:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var r=a(7462),n=(a(7294),a(3905));const o={title:"Saga pattern",slug:"saga-pattern",sidebar_position:4},i="Saga pattern",s={unversionedId:"explore/code/saga-pattern",id:"explore/code/saga-pattern",title:"Saga pattern",description:"Context and problem",source:"@site/docs/explore/code/saga-pattern.md",sourceDirName:"explore/code",slug:"/explore/code/saga-pattern",permalink:"/e-shop/explore/code/saga-pattern",draft:!1,editUrl:"https://github.com/kkhanhluu/eshop/docs/explore/code/saga-pattern.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Saga pattern",slug:"saga-pattern",sidebar_position:4},sidebar:"docs",previous:{title:"Transactional outbox pattern",permalink:"/e-shop/explore/code/transactional-outbox-pattern"},next:{title:"gRPC",permalink:"/e-shop/explore/code/gRPC"}},c={},p=[{value:"Context and problem",id:"context-and-problem",level:2},{value:"Conceptual overview",id:"conceptual-overview",level:2},{value:"Choreography",id:"choreography",level:3},{value:"Orchestration",id:"orchestration",level:3},{value:"Code details",id:"code-details",level:2},{value:"Compensating logic",id:"compensating-logic",level:3}],l={toc:p},h="wrapper";function d(e){let{components:t,...o}=e;return(0,n.kt)(h,(0,r.Z)({},l,o,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"saga-pattern"},"Saga pattern"),(0,n.kt)("h2",{id:"context-and-problem"},"Context and problem"),(0,n.kt)("p",null,"In context of a microservice system, it's very likely that you have applied ",(0,n.kt)("a",{parentName:"p",href:"https://microservices.io/patterns/data/database-per-service.html"},"database per service pattern"),". Some transactions, however, span multiple services and we need a mechanism to implement such transactions. Since each service owns different database, a local ACID transaction cannot simply be applied."),(0,n.kt)("h2",{id:"conceptual-overview"},"Conceptual overview"),(0,n.kt)("p",null,"The saga pattern provides transaction management using a sequence of local transactions. Each local transaction updates its own database and publishes a message or event to trigger the next transaction in the saga. If a local transaction fails, the saga must execute compensating transactions that undo changes that were made by preceding local transactions. This example from ",(0,n.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/saga/saga"},"Microsoft")," illustrates the pattern\n",(0,n.kt)("img",{parentName:"p",src:"https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/saga/images/saga-overview.png",alt:"saga-example"})),(0,n.kt)("h3",{id:"choreography"},"Choreography"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"Choreography")," is a way to coordinate sagas ",(0,n.kt)("inlineCode",{parentName:"p"},"without")," a centralized point of control. Each service is aware of the next saga participant after updating its own database. Here's an example of ",(0,n.kt)("inlineCode",{parentName:"p"},"choreography saga")," taken from ",(0,n.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/saga/saga"},"Microsoft"),"\n",(0,n.kt)("img",{parentName:"p",src:"https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/saga/images/choreography-pattern.png",alt:"saga-choreography"})),(0,n.kt)("h3",{id:"orchestration"},"Orchestration"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"Orchestration")," is a way to coordinate sagas ",(0,n.kt)("inlineCode",{parentName:"p"},"with")," a centralized point of control. An orchestrator (object) tells the participant what local transactions to execute. Here's an example of ",(0,n.kt)("inlineCode",{parentName:"p"},"orchestration saga")," taken from ",(0,n.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/saga/saga"},"Microsoft"),"\n",(0,n.kt)("img",{parentName:"p",src:"https://learn.microsoft.com/en-us/azure/architecture/reference-architectures/saga/images/orchestrator.png",alt:"saga-choreography"})),(0,n.kt)("h2",{id:"code-details"},"Code details"),(0,n.kt)("p",null,"Saga pattern can be checked in order service. In this example application, ",(0,n.kt)("inlineCode",{parentName:"p"},"orchestration")," was chosen to implement the saga pattern. The orchestrator object is a ",(0,n.kt)("a",{parentName:"p",href:"https://docs.spring.io/spring-statemachine/docs/current/reference/"},"Spring state machine")," which leverages traditional ",(0,n.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Finite-state_machine"},"finite-state machine concepts in computer science"),". This diagram illustrates states, state transitions and actions of the state machine."),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"state-machine",src:a(1010).Z,width:"7804",height:"1785"}),"\nStates that are decorated with double circles are start and end states. The arrow illustrate the state transition. There's an action, that will be fired, when the state is changed."),(0,n.kt)("p",null,"Here is the state machine configuration"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"state machine configuration",src:a(5789).Z,width:"1314",height:"844"})),(0,n.kt)("p",null,"And here is the definition for state machine actions"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"state machine actions",src:a(2029).Z,width:"414",height:"596"})),(0,n.kt)("h3",{id:"compensating-logic"},"Compensating logic"),(0,n.kt)("p",null,"An example for compensating logic can be found in ",(0,n.kt)("inlineCode",{parentName:"p"},"ValidateOrderFailedAction.java"),", where we want to send a message to payment service and revert the payment that user has already checked out"))}d.isMDXComponent=!0},2029:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/sm-actions-7b0fbd55ec35ae55ae4db6ea0c2908b4.png"},5789:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/sm-configuration-117c0f95018d10bb9572e74b314b2b87.png"},1010:(e,t,a)=>{a.d(t,{Z:()=>r});const r=a.p+"assets/images/state-machine-bb2d7e565108a623bcfa5c5738481367.png"}}]);